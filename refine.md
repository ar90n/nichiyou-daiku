# refine.md

## 実装計画再設計概要

現状の実装は不必要に複雑であるため、全体的に単純化する。ここで、任意の形状を表現できることを直近のマイルストーンとする。この際、実際に組み立て可能であることはスコープに含めない。（部品同士の接合方法および順序は考慮しない。） また、このマイルストーンでは2x4材のみを対象する。

## 木材の各面の呼称

2x4材はTOP, BOTTOM, FRONT, BACK, LEFT, RIGHTの各面をもつ。それぞれ以下のサイズを持つ面とする。

* TOP, BOTTOM:  38.0 * 89.0
* FRONT, BACK:  89.0 * length
* LEFT, RIGHT:  38.0 * length

## 面(Face)座標系

材料の各面ごとに独自の座標系を持つこととする。この座標系は各面の中心を原点とする。また、各面においてu軸およびv軸の方向を以下のように定義する。

* TOP, BOTTOM
  * u軸: RIGHT -> LEFT
  * v軸: BACK -> FRONT
* FRONT, BACK
  * u軸: BOTTOM -> TOP
  * v軸: RIGHT -> LEFT
* LEFT, RIGHT
  * u軸: BOTTOM -> TOP
  * v軸: BACK -> FRONT

## 接合(Joint)座標系

材料同士の接続位置は対象の面上に定義された接合座標系で行われる。この座標系は面座標系のu軸を等しい。

## 制作物の表現

制作物は材料をノード、接合をエッヂとしたグラフで表現される。グラフはnetworkxによって実現する。接合はエッヂのデータをして与える。

## 接合

接合は基準(base)面に対象（target）面を接続することで実現する。この際、以下の情報を用いることで接合を一意に表現する。

1. 基準面における接合座標系の位置
2. 対照面における接合座標系の位置
3. 基準面における接合座標系の正方向と一致する方線を持つ対象材料の面
4. 接続位置に曖昧性が存在する際に、基準材料の辺と接続する対象材料の面

1. および 2. にて基準材料と対象材料の接続位置を表現する。3. および 4. にて対象材料の姿勢（方向）を表現する。

接合のルールとして、対象面は基準面と一つ以上の辺を共有（接続）する必要がある。ここで、共有すべき辺が一意に定まらない場合（対象面が基準面に含まれる場合）、4. の情報を利用して指定された面の辺を基準面の辺と共有するように基準面のv軸方向に実際の接続位置を移動する。

この辺共有のためのv軸方向の移動には以下のパターンが存在する。

**対象面が完全に基準面に含まれる**
上述の説明のケース。4. にて指定した補助情報を利用して対象材料をv軸方向に移動する。

**対象面の一部が辺を共有する事なく基準面に含まれる**
対象面の一部が基準面に含まれている（対象面は基準面からはみ出ている）ケース。含まれている側の端面を基準面の辺に沿わせるように対象材料を移動する

## 接合データ構造の定義

**接合座標**
`face`で面を,`offset`で原点からの差異を表す
```
@dataclass(frozen=True)
class JointLocation:
    face: Face
    offset: float
```

**接合姿勢**
`aligned`で3.の面を、`aux_aligned`で4.の面を表現
```
@dataclass(frozen=True)
class JointPose:
    aligned: Face
    aux_aligned: Face
```

**接合**
```
@dataclass(frozen=True)
class GeneralJoint:
    base_loc: JointLocation
    target_loc: JointLocation
    target_pose: JointPose
```

## 実装方針

1. 不要なコードは一旦削除
2. 不要なコードは実装しない
3. TDDを維持
4. 基本、classは使わない
